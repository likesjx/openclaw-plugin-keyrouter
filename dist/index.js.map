{"version":3,"sources":["../src/openclaw-config.ts","../src/normalizer.ts","../src/retry-policy.ts","../src/router/scorer.ts","../src/state-store.ts","../src/index.ts"],"sourcesContent":["import { existsSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { homedir } from \"node:os\";\nimport { join } from \"node:path\";\nimport type { IngestedSnapshot, OpenClawConfig } from \"./types.js\";\n\nconst OPENCLAW_CONFIG_PATH = join(homedir(), \".openclaw\", \"openclaw.json\");\n\nexport function loadOpenClawConfig(): OpenClawConfig {\n  if (!existsSync(OPENCLAW_CONFIG_PATH)) {\n    return {};\n  }\n\n  const raw = readFileSync(OPENCLAW_CONFIG_PATH, \"utf-8\").trim();\n  if (!raw) {\n    return {};\n  }\n\n  return JSON.parse(raw) as OpenClawConfig;\n}\n\nexport function saveOpenClawConfig(config: OpenClawConfig): void {\n  writeFileSync(OPENCLAW_CONFIG_PATH, `${JSON.stringify(config, null, 2)}\\n`, \"utf-8\");\n}\n\nexport function setPrimaryModelSelection(args: {\n  agentId?: string;\n  modelRef: string;\n  scope: \"agent\" | \"defaults\";\n}): boolean {\n  const config = loadOpenClawConfig();\n  if (!config.agents) config.agents = {};\n\n  if (args.scope === \"agent\" && args.agentId) {\n    if (!Array.isArray(config.agents.list)) {\n      config.agents.list = [];\n    }\n    const entry = config.agents.list.find(\n      (item: unknown) =>\n        typeof item === \"object\" &&\n        item !== null &&\n        \"id\" in (item as Record<string, unknown>) &&\n        (item as { id?: string }).id === args.agentId,\n    ) as { model?: unknown } | undefined;\n    if (!entry) return false;\n\n    const current =\n      typeof entry.model === \"string\"\n        ? entry.model\n        : ((entry.model as { primary?: string } | undefined)?.primary ?? undefined);\n    if (current === args.modelRef) return false;\n\n    entry.model = args.modelRef;\n    saveOpenClawConfig(config);\n    return true;\n  }\n\n  if (!config.agents.defaults) config.agents.defaults = {};\n  if (!config.agents.defaults.model) config.agents.defaults.model = {};\n  const currentDefault =\n    typeof config.agents.defaults.model === \"string\"\n      ? config.agents.defaults.model\n      : config.agents.defaults.model?.primary;\n  if (currentDefault === args.modelRef) return false;\n  config.agents.defaults.model = args.modelRef;\n  saveOpenClawConfig(config);\n  return true;\n}\n\nexport function setSessionModelSelection(args: {\n  agentId: string;\n  providerId: string;\n  modelId: string;\n}): boolean {\n  const sessionsPath = join(\n    homedir(),\n    \".openclaw\",\n    \"agents\",\n    args.agentId,\n    \"sessions\",\n    \"sessions.json\",\n  );\n  if (!existsSync(sessionsPath)) return false;\n\n  const raw = readFileSync(sessionsPath, \"utf-8\").trim();\n  if (!raw) return false;\n  const store = JSON.parse(raw) as Record<string, Record<string, unknown>>;\n  const sessionKey = `agent:${args.agentId}:main`;\n  const entry = store[sessionKey];\n  if (!entry || typeof entry !== \"object\") return false;\n\n  const changed =\n    entry.model !== args.modelId ||\n    entry.modelOverride !== args.modelId ||\n    entry.modelProvider !== args.providerId ||\n    entry.providerOverride !== args.providerId;\n  if (!changed) return false;\n\n  entry.model = args.modelId;\n  entry.modelOverride = args.modelId;\n  entry.modelProvider = args.providerId;\n  entry.providerOverride = args.providerId;\n\n  writeFileSync(sessionsPath, `${JSON.stringify(store, null, 2)}\\n`, \"utf-8\");\n  return true;\n}\n\nexport function ingestSnapshot(config: OpenClawConfig): IngestedSnapshot {\n  const profiles = config.auth?.profiles ?? {};\n  const providers = config.models?.providers ?? {};\n\n  const providerList = Object.entries(providers)\n    .map(([id, value]) => {\n      const hasApiKey = typeof value.apiKey === \"string\" && value.apiKey.length > 0;\n      const modelCount = Array.isArray(value.models) ? value.models.length : 0;\n      return { id, modelCount, hasApiKey };\n    })\n    .sort((a, b) => a.id.localeCompare(b.id));\n\n  return {\n    authProfileCount: Object.keys(profiles).length,\n    providers: providerList,\n  };\n}\n\nexport function formatSnapshot(snapshot: IngestedSnapshot): string {\n  const lines = [\n    \"KeyRouter Ingest Report\",\n    `- Auth profiles: ${snapshot.authProfileCount}`,\n    `- Providers: ${snapshot.providers.length}`,\n  ];\n\n  for (const provider of snapshot.providers) {\n    lines.push(\n      `  - ${provider.id}: models=${provider.modelCount}, apiKey=${provider.hasApiKey ? \"yes\" : \"no\"}`,\n    );\n  }\n\n  return lines.join(\"\\n\");\n}\n","import type { NormalizedMessage, NormalizedMessagePart, NormalizedRequest } from \"./types.js\";\n\nfunction safeString(value: unknown): string {\n  if (typeof value === \"string\") {\n    return value;\n  }\n  if (typeof value === \"number\" || typeof value === \"boolean\") {\n    return String(value);\n  }\n  return \"\";\n}\n\nfunction normalizeRole(value: unknown): NormalizedMessage[\"role\"] {\n  if (value === \"system\" || value === \"developer\" || value === \"user\" || value === \"assistant\" || value === \"tool\") {\n    return value;\n  }\n  return \"unknown\";\n}\n\nfunction asArray(value: unknown): unknown[] {\n  return Array.isArray(value) ? value : [];\n}\n\nfunction parsePart(part: unknown): NormalizedMessagePart {\n  if (typeof part === \"string\") {\n    return { type: \"text\", text: part };\n  }\n\n  if (!part || typeof part !== \"object\") {\n    return { type: \"unknown\", payload: part };\n  }\n\n  const record = part as Record<string, unknown>;\n  const type = safeString(record.type).toLowerCase();\n\n  if (type === \"text\") {\n    return { type: \"text\", text: safeString(record.text) };\n  }\n  if (type === \"image\" || type === \"image_url\") {\n    return {\n      type: \"image\",\n      imageUrl: safeString(record.imageUrl || record.url || (record.image_url as Record<string, unknown>)?.url),\n    };\n  }\n  if (type === \"tool_call\") {\n    return {\n      type: \"tool_call\",\n      toolName: safeString(record.name || (record.function as Record<string, unknown>)?.name),\n      toolCallId: safeString(record.id || record.tool_call_id),\n      payload: record,\n    };\n  }\n  if (type === \"tool_result\") {\n    return {\n      type: \"tool_result\",\n      toolCallId: safeString(record.tool_call_id || record.id),\n      payload: record,\n    };\n  }\n  if (type === \"json\") {\n    return { type: \"json\", payload: record };\n  }\n\n  if (record.tool_calls) {\n    return { type: \"tool_call\", payload: record, toolName: \"unknown\" };\n  }\n\n  if (record.content && typeof record.content !== \"string\") {\n    return { type: \"json\", payload: record.content };\n  }\n\n  return { type: \"unknown\", payload: record };\n}\n\nfunction normalizeMessage(message: unknown): NormalizedMessage {\n  if (typeof message === \"string\") {\n    return {\n      role: \"user\",\n      parts: [{ type: \"text\", text: message }],\n    };\n  }\n\n  if (!message || typeof message !== \"object\") {\n    return {\n      role: \"unknown\",\n      parts: [{ type: \"unknown\", payload: message }],\n    };\n  }\n\n  const record = message as Record<string, unknown>;\n  const role = normalizeRole(record.role);\n\n  const content = record.content;\n  let parts: NormalizedMessagePart[] = [];\n\n  if (typeof content === \"string\") {\n    parts = [{ type: \"text\", text: content }];\n  } else if (Array.isArray(content)) {\n    parts = content.map(parsePart);\n  } else if (content && typeof content === \"object\") {\n    parts = [parsePart(content)];\n  }\n\n  if ((record.tool_calls && Array.isArray(record.tool_calls)) || role === \"tool\") {\n    const toolParts = asArray(record.tool_calls).map(parsePart);\n    parts = parts.concat(toolParts.length ? toolParts : [{ type: role === \"tool\" ? \"tool_result\" : \"tool_call\", payload: record }]);\n  }\n\n  if (!parts.length) {\n    parts = [{ type: \"unknown\", payload: record }];\n  }\n\n  return { role, parts };\n}\n\nfunction collectPlainText(messages: NormalizedMessage[]): string {\n  const chunks: string[] = [];\n  for (const message of messages) {\n    for (const part of message.parts) {\n      if (part.text) {\n        chunks.push(part.text);\n      }\n      if (!part.text && part.type === \"tool_call\" && part.toolName) {\n        chunks.push(`tool:${part.toolName}`);\n      }\n    }\n  }\n  return chunks.join(\"\\n\").trim();\n}\n\nexport function normalizeRequest(input: unknown): NormalizedRequest {\n  const messages = Array.isArray(input)\n    ? input.map(normalizeMessage)\n    : [normalizeMessage(input)];\n\n  const plainText = collectPlainText(messages);\n\n  let hasImage = false;\n  let hasToolCall = false;\n  let hasToolResult = false;\n\n  for (const message of messages) {\n    for (const part of message.parts) {\n      if (part.type === \"image\") hasImage = true;\n      if (part.type === \"tool_call\") hasToolCall = true;\n      if (part.type === \"tool_result\") hasToolResult = true;\n    }\n  }\n\n  return {\n    messages,\n    plainText,\n    hasImage,\n    hasToolCall,\n    hasToolResult,\n  };\n}\n\nexport function parseCommandInput(args?: string): unknown {\n  const raw = (args || \"\").trim();\n  if (!raw) {\n    return [{ role: \"user\", content: \"\" }];\n  }\n\n  if (raw.startsWith(\"{\" ) || raw.startsWith(\"[\")) {\n    try {\n      return JSON.parse(raw);\n    } catch {\n      return [{ role: \"user\", content: raw }];\n    }\n  }\n\n  return [{ role: \"user\", content: raw }];\n}\n","import type { RetryErrorClass, RetryRecommendation, RouteCandidate } from \"./types.js\";\n\nexport function classifyError(input: string): RetryErrorClass {\n  const s = input.toLowerCase();\n  if (s.includes(\"quota\") || s.includes(\"insufficient_quota\") || s.includes(\"billing\")) {\n    return \"quota_exhausted\";\n  }\n  if (s.includes(\"429\") || s.includes(\"rate limit\") || s.includes(\"too many requests\")) {\n    return \"rate_limited\";\n  }\n  if (s.includes(\"401\") || s.includes(\"403\") || s.includes(\"invalid api key\") || s.includes(\"unauthorized\")) {\n    return \"auth_invalid\";\n  }\n  if (s.includes(\"timeout\") || s.includes(\"econnreset\") || s.includes(\"network\") || s.includes(\"temporar\")) {\n    return \"transient_network\";\n  }\n  if (s.includes(\"500\") || s.includes(\"502\") || s.includes(\"503\") || s.includes(\"504\") || s.includes(\"internal error\")) {\n    return \"server_error\";\n  }\n  return \"unknown\";\n}\n\nexport function retryRecommendation(\n  errorClass: RetryErrorClass,\n  attempt: number,\n  maxAttempts = 3,\n  hasTooling = false\n): RetryRecommendation {\n  const hasAttemptsLeft = attempt < maxAttempts;\n\n  switch (errorClass) {\n    case \"quota_exhausted\":\n      return {\n        errorClass,\n        shouldRetry: hasAttemptsLeft,\n        shouldSwitchModel: true,\n        strategy: hasTooling ? \"immediate_fallback\" : \"default\",\n        reason: hasTooling\n          ? \"hard quota during tool workflow; rapid fallback to reliable redundant model\"\n          : \"hard quota condition; switch candidate tier/provider\",\n      };\n    case \"rate_limited\":\n      return {\n        errorClass,\n        shouldRetry: hasAttemptsLeft,\n        shouldSwitchModel: true,\n        reason: \"rate limit encountered; switch to adjacent model or provider\",\n      };\n    case \"auth_invalid\":\n      return {\n        errorClass,\n        shouldRetry: false,\n        shouldSwitchModel: true,\n        reason: \"credentials invalid; do not retry same provider key\",\n      };\n    case \"transient_network\":\n      return {\n        errorClass,\n        shouldRetry: hasAttemptsLeft,\n        shouldSwitchModel: false,\n        reason: \"transient transport issue; retry same target first\",\n      };\n    case \"server_error\":\n      return {\n        errorClass,\n        shouldRetry: hasAttemptsLeft,\n        shouldSwitchModel: hasAttemptsLeft,\n        reason: \"server instability; retry then switch on repeated failures\",\n      };\n    default:\n      return {\n        errorClass,\n        shouldRetry: hasAttemptsLeft,\n        shouldSwitchModel: hasAttemptsLeft,\n        reason: \"unknown error; conservative bounded retry with fallback\",\n      };\n  }\n}\n\nexport function nextCandidate(candidates: RouteCandidate[], currentIndex: number): RouteCandidate | null {\n  if (currentIndex + 1 >= candidates.length) {\n    return null;\n  }\n  return candidates[currentIndex + 1] ?? null;\n}\n","import type {\n  OpenClawConfig,\n  OpenClawProviderModel,\n  KeyRouterProviderPolicy,\n  RouteCandidate,\n  RouteDecision,\n  RouteDimensionScores,\n  NormalizedRequest,\n} from \"../types.js\";\n\nfunction clamp01(v: number): number {\n  return Math.max(0, Math.min(1, v));\n}\n\nfunction inferDimensions(input: NormalizedRequest): RouteDimensionScores {\n  const text = input.plainText.toLowerCase();\n  const tokens = text.split(/\\s+/).filter(Boolean).length;\n\n  const reasoningHints = [\"why\", \"prove\", \"reason\", \"analyze\", \"tradeoff\", \"formal\"];\n  const codingHints = [\"code\", \"refactor\", \"debug\", \"typescript\", \"python\", \"api\", \"plugin\"];\n  const latencyHints = [\"quick\", \"fast\", \"brief\", \"short\"];\n  const costHints = [\"cheap\", \"low cost\", \"budget\", \"save\", \"free\"];\n\n  const hasAny = (hints: string[]): boolean => hints.some((h) => text.includes(h));\n\n  const complexity = clamp01(tokens / 240);\n  const reasoning = hasAny(reasoningHints) ? 0.85 : clamp01(complexity * 0.6);\n  const coding = hasAny(codingHints) ? 0.9 : clamp01(complexity * 0.4);\n  const multimodal = input.hasImage ? 1 : 0;\n  const tooling = input.hasToolCall || input.hasToolResult ? 0.9 : 0.2;\n  const contextPressure = clamp01(tokens / 1000);\n  const latencySensitivity = hasAny(latencyHints) ? 0.85 : 0.35;\n  const costSensitivity = hasAny(costHints) ? 0.9 : 0.4;\n\n  return {\n    complexity,\n    reasoning,\n    coding,\n    multimodal,\n    tooling,\n    contextPressure,\n    latencySensitivity,\n    costSensitivity,\n  };\n}\n\nfunction selectPolicy(dim: RouteDimensionScores): \"cheap\" | \"balanced\" | \"reasoning\" {\n  if (dim.reasoning > 0.72 || dim.complexity > 0.82) {\n    return \"reasoning\";\n  }\n  if (dim.costSensitivity > 0.75 && dim.latencySensitivity > 0.6) {\n    return \"cheap\";\n  }\n  return \"balanced\";\n}\n\ntype CandidateSeed = {\n  providerId: string;\n  model: OpenClawProviderModel;\n  hasApiKey: boolean;\n};\n\nfunction flattenCandidates(config: OpenClawConfig): CandidateSeed[] {\n  const providers = config.models?.providers ?? {};\n  const out: CandidateSeed[] = [];\n\n  for (const [providerId, provider] of Object.entries(providers)) {\n    const models = Array.isArray(provider.models) ? provider.models : [];\n    const hasApiKey = typeof provider.apiKey === \"string\" && provider.apiKey.length > 0;\n\n    for (const model of models) {\n      out.push({ providerId, model, hasApiKey });\n    }\n  }\n\n  return out;\n}\n\nfunction applyProviderPolicy(\n  seeds: CandidateSeed[],\n  policy?: KeyRouterProviderPolicy,\n): CandidateSeed[] {\n  if (!policy) return seeds;\n  const deny = new Set((policy.deny ?? []).map((v) => v.trim()).filter(Boolean));\n  const allow = new Set((policy.allow ?? []).map((v) => v.trim()).filter(Boolean));\n  let out = seeds.filter((s) => !deny.has(s.providerId));\n  if (allow.size > 0) {\n    out = out.filter((s) => allow.has(s.providerId));\n  }\n  return out;\n}\n\nfunction modelName(seed: CandidateSeed): string {\n  return `${seed.providerId}/${seed.model.id}`.toLowerCase();\n}\n\nfunction matchesMultimodal(seed: CandidateSeed, requiresImage: boolean): boolean {\n  if (!requiresImage) {\n    return true;\n  }\n  return Array.isArray(seed.model.input) && seed.model.input.includes(\"image\");\n}\n\nfunction modelScore(\n  seed: CandidateSeed,\n  dim: RouteDimensionScores,\n  policy: \"cheap\" | \"balanced\" | \"reasoning\",\n  providerPolicy?: KeyRouterProviderPolicy,\n): number {\n  const id = modelName(seed);\n  const inputCost = seed.model.cost?.input;\n  const outputCost = seed.model.cost?.output;\n  const cost = (typeof inputCost === \"number\" ? inputCost : 999) + (typeof outputCost === \"number\" ? outputCost : 999);\n\n  let score = 0;\n\n  if (policy === \"cheap\") {\n    score += 1 / (1 + cost);\n    score += dim.latencySensitivity * (id.includes(\"flash\") || id.includes(\"mini\") ? 0.5 : 0.1);\n  } else if (policy === \"reasoning\") {\n    score += dim.reasoning * (id.includes(\"reason\") || id.includes(\"o3\") || id.includes(\"thinking\") ? 1.2 : 0.2);\n    score += dim.coding * (id.includes(\"code\") || id.includes(\"codex\") ? 0.8 : 0.1);\n  } else {\n    score += dim.complexity * 0.4;\n    score += dim.reasoning * (id.includes(\"pro\") || id.includes(\"sonnet\") ? 0.6 : 0.2);\n    score += 1 / (1 + cost * 0.6);\n  }\n\n  if (id.includes(\"gemini-3-flash\") || id.includes(\"gpt-4o-mini\")) {\n    score += dim.latencySensitivity * 0.2;\n  }\n\n  if (seed.hasApiKey) {\n    score += 0.05;\n  }\n\n  const prefer = new Set((providerPolicy?.prefer ?? []).map((v) => v.trim()).filter(Boolean));\n  if (prefer.has(seed.providerId)) {\n    score += 0.15;\n  }\n\n  return score;\n}\n\nexport function routeRequest(\n  input: NormalizedRequest,\n  config: OpenClawConfig,\n  opts?: { providerPolicy?: KeyRouterProviderPolicy },\n): RouteDecision {\n  const dimensions = inferDimensions(input);\n  const policy = selectPolicy(dimensions);\n\n  const candidates = applyProviderPolicy(flattenCandidates(config), opts?.providerPolicy)\n    .filter((seed) => matchesMultimodal(seed, input.hasImage))\n    .map((seed): RouteCandidate => {\n      const score = modelScore(seed, dimensions, policy, opts?.providerPolicy);\n      return {\n        providerId: seed.providerId,\n        modelId: seed.model.id,\n        score,\n        inputCost: seed.model.cost?.input,\n        outputCost: seed.model.cost?.output,\n        rationale: `policy=${policy}, apiKey=${seed.hasApiKey ? \"yes\" : \"no\"}`,\n      };\n    })\n    .sort((a, b) => b.score - a.score)\n    .slice(0, 8);\n\n  return {\n    policy,\n    dimensions,\n    topCandidates: candidates,\n  };\n}\n\nexport function formatDecision(decision: RouteDecision): string {\n  const lines = [\n    \"KeyRouter Route Decision\",\n    `- Policy: ${decision.policy}`,\n    `- Dimensions: ${JSON.stringify(decision.dimensions)}`,\n    \"- Top candidates:\",\n  ];\n\n  if (!decision.topCandidates.length) {\n    lines.push(\"  - (none)\");\n  } else {\n    for (const c of decision.topCandidates) {\n      lines.push(\n        `  - ${c.providerId}/${c.modelId}: score=${c.score.toFixed(4)}, cost=${c.inputCost ?? \"?\"}/${c.outputCost ?? \"?\"}, ${c.rationale}`,\n      );\n    }\n  }\n\n  return lines.join(\"\\n\");\n}\n","import { existsSync, mkdirSync, readFileSync, writeFileSync } from \"node:fs\";\nimport { homedir } from \"node:os\";\nimport { join } from \"node:path\";\nimport type { KeyRouterState, QuotaEntry, RetryErrorClass, UsageEvent } from \"./types.js\";\n\nconst STATE_DIR = join(homedir(), \".openclaw\", \"keyrouter\");\nconst STATE_PATH = join(STATE_DIR, \"state.json\");\nconst MAX_USAGE_EVENTS = 1000;\n\nfunction ensureDir(): void {\n  if (!existsSync(STATE_DIR)) {\n    mkdirSync(STATE_DIR, { recursive: true });\n  }\n}\n\nexport function loadState(): KeyRouterState {\n  ensureDir();\n  if (!existsSync(STATE_PATH)) {\n    return { usage: [], quota: {} };\n  }\n\n  try {\n    const raw = readFileSync(STATE_PATH, \"utf-8\").trim();\n    if (!raw) return { usage: [], quota: {} };\n    const parsed = JSON.parse(raw) as KeyRouterState;\n    return {\n      usage: Array.isArray(parsed.usage) ? parsed.usage : [],\n      quota: parsed.quota && typeof parsed.quota === \"object\" ? parsed.quota : {},\n    };\n  } catch {\n    return { usage: [], quota: {} };\n  }\n}\n\nexport function saveState(state: KeyRouterState): void {\n  ensureDir();\n  writeFileSync(STATE_PATH, JSON.stringify(state, null, 2));\n}\n\nexport function recordUsage(event: Omit<UsageEvent, \"at\">): KeyRouterState {\n  const state = loadState();\n  state.usage.push({ ...event, at: new Date().toISOString() });\n  if (state.usage.length > MAX_USAGE_EVENTS) {\n    state.usage = state.usage.slice(state.usage.length - MAX_USAGE_EVENTS);\n  }\n  saveState(state);\n  return state;\n}\n\nexport function setQuota(modelKey: string, quota: QuotaEntry): KeyRouterState {\n  const state = loadState();\n  state.quota[modelKey] = quota;\n  saveState(state);\n  return state;\n}\n\nexport function applyCooldown(modelKey: string, minutes: number): KeyRouterState {\n  const state = loadState();\n  const existing = state.quota[modelKey] ?? {};\n  const cooldownUntil = new Date(Date.now() + minutes * 60 * 1000).toISOString();\n  state.quota[modelKey] = {\n    ...existing,\n    cooldownUntil,\n  };\n  saveState(state);\n  return state;\n}\n\nexport function summarizeUsage(state: KeyRouterState): string {\n  const lines = [\n    \"KeyRouter Usage Summary\",\n    `- Events: ${state.usage.length}`,\n  ];\n\n  const grouped = new Map<string, { total: number; failed: number; routed: number; success: number }>();\n  for (const event of state.usage) {\n    const key = `${event.providerId}/${event.modelId}`;\n    const entry = grouped.get(key) ?? { total: 0, failed: 0, routed: 0, success: 0 };\n    entry.total += 1;\n    if (event.status === \"failed\") entry.failed += 1;\n    if (event.status === \"routed\") entry.routed += 1;\n    if (event.status === \"success\") entry.success += 1;\n    grouped.set(key, entry);\n  }\n\n  if (!grouped.size) {\n    lines.push(\"- No usage yet\");\n  } else {\n    lines.push(\"- By model:\");\n    for (const [key, g] of grouped.entries()) {\n      lines.push(`  - ${key}: total=${g.total}, routed=${g.routed}, success=${g.success}, failed=${g.failed}`);\n    }\n  }\n\n  return lines.join(\"\\n\");\n}\n\nexport function summarizeQuota(state: KeyRouterState): string {\n  const lines = [\n    \"KeyRouter Quota Summary\",\n    `- Entries: ${Object.keys(state.quota).length}`,\n  ];\n\n  if (!Object.keys(state.quota).length) {\n    lines.push(\"- No quota records yet\");\n    return lines.join(\"\\n\");\n  }\n\n  for (const [modelKey, q] of Object.entries(state.quota)) {\n    lines.push(\n      `  - ${modelKey}: remaining=${q.remaining ?? \"?\"}, resetAt=${q.resetAt ?? \"?\"}, cooldownUntil=${q.cooldownUntil ?? \"-\"}`,\n    );\n  }\n\n  return lines.join(\"\\n\");\n}\n\nexport function markFailureWithError(modelKey: string, errorClass: RetryErrorClass): KeyRouterState {\n  const cooldown = errorClass === \"rate_limited\" ? 2 : errorClass === \"quota_exhausted\" ? 10 : 1;\n  return applyCooldown(modelKey, cooldown);\n}\n","import {\n  ingestSnapshot,\n  formatSnapshot,\n  loadOpenClawConfig,\n  setPrimaryModelSelection,\n  setSessionModelSelection,\n} from \"./openclaw-config.js\";\nimport { normalizeRequest, parseCommandInput } from \"./normalizer.js\";\nimport { classifyError, nextCandidate, retryRecommendation } from \"./retry-policy.js\";\nimport { routeRequest, formatDecision } from \"./router/scorer.js\";\nimport {\n  loadState,\n  markFailureWithError,\n  recordUsage,\n  setQuota,\n  summarizeQuota,\n  summarizeUsage,\n} from \"./state-store.js\";\nimport type {\n  KeyRouterPluginConfig,\n  OpenClawPluginDefinition,\n  KeyRouterProviderPolicy,\n} from \"./types.js\";\n\nconst VERSION = \"0.1.0\";\n\nfunction runAudit() {\n  const config = loadOpenClawConfig();\n  const snapshot = ingestSnapshot(config);\n  return formatSnapshot(snapshot);\n}\n\nfunction runRoute(rawArgs: string, providerPolicy?: KeyRouterProviderPolicy) {\n  const config = loadOpenClawConfig();\n  const normalized = normalizeRequest(parseCommandInput(rawArgs));\n  const decision = routeRequest(normalized, config, { providerPolicy });\n\n  if (decision.topCandidates[0]) {\n    const top = decision.topCandidates[0];\n    recordUsage({\n      providerId: top.providerId,\n      modelId: top.modelId,\n      status: \"routed\",\n    });\n  }\n\n  return formatDecision(decision);\n}\n\nfunction runRetry(errorText: string, providerPolicy?: KeyRouterProviderPolicy) {\n  const errorClass = classifyError(errorText);\n  const recommendation = retryRecommendation(errorClass, 1, 3, true); // tooling-focused path\n  const config = loadOpenClawConfig();\n  const normalized = normalizeRequest([{ role: \"user\", content: \"fallback probe\" }]);\n  const decision = routeRequest(normalized, config, { providerPolicy });\n  const alternate = nextCandidate(decision.topCandidates, 0);\n\n  if (decision.topCandidates[0]) {\n    const top = decision.topCandidates[0];\n    const modelKey = `${top.providerId}/${top.modelId}`;\n    markFailureWithError(modelKey, errorClass);\n    recordUsage({\n      providerId: top.providerId,\n      modelId: top.modelId,\n      status: \"failed\",\n      errorClass,\n    });\n  }\n\n  const lines = [\n    \"KeyRouter Retry Recommendation\",\n    `- errorClass: ${recommendation.errorClass}`,\n    `- shouldRetry: ${recommendation.shouldRetry}`,\n    `- shouldSwitchModel: ${recommendation.shouldSwitchModel}`,\n    `- strategy: ${recommendation.strategy || \"default\"}`,\n    `- reason: ${recommendation.reason}`,\n    `- alternateCandidate: ${alternate ? `${alternate.providerId}/${alternate.modelId}` : \"(none)\"}`,\n  ];\n  return lines.join(\"\\n\");\n}\n\nfunction autoRouteModel(\n  input: { prompt: string; messages?: unknown[] },\n  providerPolicy?: KeyRouterProviderPolicy,\n) {\n  const prompt = String(input.prompt || \"\").trim();\n  if (!prompt) return undefined;\n  if (prompt.startsWith(\"/keyrouter_\")) return undefined;\n\n  const config = loadOpenClawConfig();\n  const payload = Array.isArray(input.messages) && input.messages.length > 0\n    ? input.messages\n    : [{ role: \"user\", content: prompt }];\n  const normalized = normalizeRequest(payload);\n  const decision = routeRequest(normalized, config, { providerPolicy });\n  const top = decision.topCandidates[0];\n  if (!top) return undefined;\n\n  const providerOverride = top.providerId;\n  const modelOverride = top.modelId;\n  recordUsage({\n    providerId: top.providerId,\n    modelId: top.modelId,\n    status: \"routed\",\n  });\n  return { providerOverride, modelOverride, decision };\n}\n\nfunction resolvePluginConfig(raw: unknown): Required<KeyRouterPluginConfig> {\n  const src = (raw || {}) as KeyRouterPluginConfig;\n  return {\n    enabled: src.enabled !== false,\n    providers: {\n      allow: src.providers?.allow ?? [],\n      prefer: src.providers?.prefer ?? [],\n      deny: src.providers?.deny ?? [],\n    },\n    hardApply: {\n      enabled: src.hardApply?.enabled ?? false,\n      mode: src.hardApply?.mode ?? \"override\",\n      pinScope: src.hardApply?.pinScope ?? \"agent\",\n    },\n  };\n}\n\nconst plugin: OpenClawPluginDefinition = {\n  id: \"openclaw-plugin-keyrouter\",\n  name: \"KeyRouter\",\n  description: \"BYOK router scaffold that ingests OpenClaw auth/model configuration\",\n  version: VERSION,\n\n  register(api) {\n    api.logger.info(\"KeyRouter scaffold loaded\");\n    const pluginConfig = resolvePluginConfig(api.pluginConfig);\n    const providerPolicy = pluginConfig.providers;\n    const hardApply = pluginConfig.hardApply;\n    const pendingPinBySessionKey = new Map<\n      string,\n      { agentId: string; providerId: string; modelId: string; modelRef: string }\n    >();\n\n    if (!pluginConfig.enabled) {\n      api.logger.info(\"KeyRouter disabled via plugin config\");\n      return;\n    }\n\n    api.on(\"before_model_resolve\", async (event: unknown) => {\n      try {\n        const payload = (event || {}) as { prompt?: string; messages?: unknown[] };\n        const routed = autoRouteModel({\n          prompt: payload.prompt || \"\",\n          messages: payload.messages,\n        }, providerPolicy);\n        if (!routed) return;\n        const modelRef = `${routed.providerOverride}/${routed.modelOverride}`;\n        api.logger.info(`KeyRouter auto-route(model_resolve) -> ${modelRef}`);\n        if (hardApply.enabled && hardApply.mode === \"override\") {\n          return {\n            providerOverride: routed.providerOverride,\n            modelOverride: routed.modelOverride,\n          };\n        }\n        return;\n      } catch (err) {\n        api.logger.warn(\n          `KeyRouter auto-route(model_resolve) skipped: ${\n            err instanceof Error ? err.message : String(err)\n          }`,\n        );\n        return;\n      }\n    });\n\n    // Fallback for older runtimes that only apply model overrides here.\n    api.on(\"before_agent_start\", async (event: unknown, hookCtx: unknown) => {\n      try {\n        const payload = (event || {}) as { prompt?: string; messages?: unknown[]; agentId?: string };\n        const context = (hookCtx || {}) as { agentId?: string; sessionKey?: string };\n        const agentId = context.agentId || payload.agentId;\n        const routed = autoRouteModel({\n          prompt: payload.prompt || \"\",\n          messages: payload.messages,\n        }, providerPolicy);\n        if (!routed) return;\n        const modelRef = `${routed.providerOverride}/${routed.modelOverride}`;\n        api.logger.info(`KeyRouter auto-route(agent_start) -> ${modelRef}`);\n\n        if (hardApply.enabled && hardApply.mode === \"pin\") {\n          const changed = setPrimaryModelSelection({\n            agentId,\n            modelRef,\n            scope: hardApply.pinScope ?? \"agent\",\n          });\n          const sessionPinned =\n            !!agentId &&\n            setSessionModelSelection({\n              agentId,\n              providerId: routed.providerOverride,\n              modelId: routed.modelOverride,\n            });\n          if (agentId && context.sessionKey) {\n            pendingPinBySessionKey.set(context.sessionKey, {\n              agentId,\n              providerId: routed.providerOverride,\n              modelId: routed.modelOverride,\n              modelRef,\n            });\n          }\n          if (changed) {\n            api.logger.info(\n              `KeyRouter hard-apply(pin) -> ${modelRef} (${hardApply.pinScope}${agentId ? `:${agentId}` : \"\"})`,\n            );\n          }\n          if (sessionPinned) {\n            api.logger.info(`KeyRouter hard-apply(session) -> ${modelRef} (agent:${agentId}:main)`);\n          }\n          return;\n        }\n\n        if (hardApply.enabled && hardApply.mode === \"override\") {\n          return {\n            providerOverride: routed.providerOverride,\n            modelOverride: routed.modelOverride,\n          };\n        }\n      } catch {\n        return;\n      }\n    });\n\n    api.on(\"agent_end\", async (_event: unknown, hookCtx: unknown) => {\n      if (!(hardApply.enabled && hardApply.mode === \"pin\")) return;\n      const context = (hookCtx || {}) as { sessionKey?: string };\n      const sessionKey = context.sessionKey;\n      if (!sessionKey) return;\n      const pending = pendingPinBySessionKey.get(sessionKey);\n      if (!pending) return;\n      pendingPinBySessionKey.delete(sessionKey);\n      const applied = setSessionModelSelection({\n        agentId: pending.agentId,\n        providerId: pending.providerId,\n        modelId: pending.modelId,\n      });\n      if (applied) {\n        api.logger.info(`KeyRouter hard-apply(agent_end) -> ${pending.modelRef} (${sessionKey})`);\n      }\n    });\n\n    api.registerCommand({\n      name: \"keyrouter_audit\",\n      description: \"Inspect auth profiles and model providers from ~/.openclaw/openclaw.json\",\n      acceptsArgs: false,\n      requireAuth: false,\n      handler: async () => {\n        try {\n          return { text: runAudit() };\n        } catch (err) {\n          return {\n            text: `KeyRouter audit failed: ${err instanceof Error ? err.message : String(err)}`,\n            isError: true,\n          };\n        }\n      },\n    });\n\n    api.registerCommand({\n      name: \"keyrouter_route\",\n      description: \"Run multi-dimension routing over an input prompt or JSON message envelope\",\n      acceptsArgs: true,\n      requireAuth: false,\n      handler: async (ctx) => {\n        try {\n          const args = (ctx.args || \"\").trim();\n          return { text: runRoute(args, providerPolicy) };\n        } catch (err) {\n          return {\n            text: `KeyRouter route failed: ${err instanceof Error ? err.message : String(err)}`,\n            isError: true,\n          };\n        }\n      },\n    });\n\n    api.registerCommand({\n      name: \"keyrouter_retry\",\n      description:\n        \"Classify an error and show retry/fallback recommendation. Usage: /keyrouter_retry <error text>\",\n      acceptsArgs: true,\n      requireAuth: false,\n      handler: async (ctx) => {\n        const errorText = (ctx.args || \"\").trim();\n        if (!errorText) {\n          return {\n            text: \"Usage: /keyrouter_retry <error text>\",\n            isError: true,\n          };\n        }\n\n        return { text: runRetry(errorText, providerPolicy) };\n      },\n    });\n\n    api.registerCommand({\n      name: \"keyrouter_usage\",\n      description: \"Show usage summary from KeyRouter local state\",\n      acceptsArgs: false,\n      requireAuth: false,\n      handler: async () => {\n        const state = loadState();\n        return { text: summarizeUsage(state) };\n      },\n    });\n\n    api.registerCommand({\n      name: \"keyrouter_quota\",\n      description: \"Show quota/cooldown summary from KeyRouter local state\",\n      acceptsArgs: false,\n      requireAuth: false,\n      handler: async () => {\n        const state = loadState();\n        return { text: summarizeQuota(state) };\n      },\n    });\n\n    api.registerCommand({\n      name: \"keyrouter_quota_set\",\n      description:\n        \"Set quota state for a model key. Usage: /keyrouter_quota_set <provider/model> <remaining> [reset-iso]\",\n      acceptsArgs: true,\n      requireAuth: false,\n      handler: async (ctx) => {\n        const raw = (ctx.args || \"\").trim();\n        const [modelKey, remainingRaw, resetAt] = raw.split(/\\s+/);\n        if (!modelKey || !remainingRaw) {\n          return {\n            text: \"Usage: /keyrouter_quota_set <provider/model> <remaining> [reset-iso]\",\n            isError: true,\n          };\n        }\n        const remaining = Number(remainingRaw);\n        if (!Number.isFinite(remaining)) {\n          return { text: `Invalid remaining value: ${remainingRaw}`, isError: true };\n        }\n        setQuota(modelKey, { remaining, resetAt });\n        return { text: `Quota updated for ${modelKey}` };\n      },\n    });\n\n    api.registerCli(\n      ({ program }) => {\n        const keyrouter = program.command(\"keyrouter\") as any;\n        keyrouter.description(\"KeyRouter BYOK router utilities\");\n\n        keyrouter\n          .command(\"audit\")\n          .description(\"Inspect auth profiles and model providers from ~/.openclaw/openclaw.json\")\n          .action(() => {\n            console.log(runAudit());\n          });\n\n        keyrouter\n          .command(\"route\")\n          .description(\"Run multi-dimension routing for a prompt or JSON envelope\")\n          .argument(\"<input>\", \"Prompt text or JSON message envelope\")\n          .action((input: string) => {\n            console.log(runRoute(String(input || \"\"), providerPolicy));\n          });\n\n        keyrouter\n          .command(\"retry\")\n          .description(\"Classify an error and print retry/fallback recommendation\")\n          .argument(\"<error>\", \"Error text to classify\")\n          .action((errorText: string) => {\n            console.log(runRetry(String(errorText || \"\"), providerPolicy));\n          });\n\n        keyrouter\n          .command(\"usage\")\n          .description(\"Show KeyRouter usage summary\")\n          .action(() => {\n            console.log(summarizeUsage(loadState()));\n          });\n\n        keyrouter\n          .command(\"quota\")\n          .description(\"Show KeyRouter quota/cooldown summary\")\n          .action(() => {\n            console.log(summarizeQuota(loadState()));\n          });\n\n        keyrouter\n          .command(\"quota-set\")\n          .description(\"Set quota for a model key\")\n          .argument(\"<modelKey>\", \"Provider/model key\")\n          .argument(\"<remaining>\", \"Remaining quota count\")\n          .argument(\"[resetAt]\", \"Optional reset ISO timestamp\")\n          .action((modelKey: string, remainingRaw: string, resetAt?: string) => {\n            const remaining = Number(remainingRaw);\n            if (!Number.isFinite(remaining)) {\n              throw new Error(`Invalid remaining value: ${remainingRaw}`);\n            }\n            setQuota(String(modelKey), { remaining, resetAt });\n            console.log(`Quota updated for ${modelKey}`);\n          });\n      },\n      { commands: [\"keyrouter\"] },\n    );\n  },\n};\n\nexport default plugin;\n"],"mappings":"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","names":["existsSync","readFileSync","writeFileSync","homedir","join"]}